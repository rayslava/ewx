name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libwlroots-dev \
          libwayland-dev \
          wayland-protocols \
          libxkbcommon-dev \
          clang \
          clang-format \
          clang-tools \
          cppcheck \
          emacs-nox

    - name: Check format
      run: |
        echo "Checking C code formatting..."
        for file in $(sed -ne '/SRCS/s/.*=//p' Makefile); do
          if ! clang-format -style=Google --dry-run --Werror "$file" >/dev/null 2>&1; then
            echo "FAILED: $file is not formatted according to Google style"
            echo "Expected formatting:"
            clang-format -style=Google "$file" | diff -u "$file" - || true
            exit 1
          else
            echo "PASSED: $file"
          fi
        done

    - name: Build EWS part
      run: |
        echo "Testing compilation with different compilers..."

        make clean
        make CC=gcc ews
        echo "PASSED: GCC compilation successful"

        make clean
        make CC=clang ews
        echo "PASSED: Clang compilation successful"

    - name: Run cppcheck
      run: |
        echo "Running cppcheck static analysis..."
        cppcheck \
          --enable=all \
          --error-exitcode=1 \
          --std=c11 \
          -I. \
          -DWLR_USE_UNSTABLE \
          ews.c 2>&1 | tee cppcheck-results.txt

        echo "Cppcheck completed. Results:"
        cat cppcheck-results.txt

    - name: Run clang static analyzer
      run: |
        echo "Running clang static analyzer..."
        make clean

        scan-build \
          --status-bugs \
          --view-config \
          -analyze-headers \
          -enable-checker security,unix,core,deadcode,alpha \
          -o clang-analysis \
          make CC=clang ews

        if [ -d "clang-analysis" ] && [ "$(ls -A clang-analysis)" ]; then
          echo "WARNING: Static analysis found potential issues:"
          find clang-analysis -name "*.html" -exec echo "Report: {}" \;
          exit 1
        else
          echo "PASSED: No static analysis issues found"
        fi

    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: analysis-results
        path: |
          cppcheck-results.txt
          clang-analysis/
        retention-days: 30

  codeql-analysis:
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: cpp

    - name: Install dependencies for CodeQL
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          pkg-config \
          libwlroots-dev \
          libwayland-dev \
          wayland-protocols \
          libxkbcommon-dev

    - name: Build for CodeQL
      run: |
        make clean
        make ews

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
